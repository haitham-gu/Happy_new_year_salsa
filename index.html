<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#05030b" />
    <title>Happy New Year, My Love</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=Inter:wght@300;400;500&family=Dancing+Script:wght@400;600;700&family=Great+Vibes&display=swap" rel="stylesheet" />

    <style>
        /*
            Romantic cinematic single-file experience
            - Aurora ribbons + moving glow
            - Film grain + vignette (cinema texture)
            - Hearts, sparkles, fireworks (canvas)
            - Progressive text reveal
            - Parallax motion on pointer
            - Music autoplay (ny.mp3) with best-effort workaround
        */

        :root {
            color-scheme: dark;
            --bg0: #04020a;
            --bg1: #07061a;
            --ink: rgba(255, 246, 242, 0.96);
            --muted: rgba(255, 246, 242, 0.72);
            --stroke: rgba(255, 246, 242, 0.16);
            --glass: rgba(10, 8, 18, 0.54);
            --rose: #ff4d8d;
            --blush: #ff9ec0;
            --violet: #b46bff;
            --sky: #66d8ff;
            --gold: #ffd1a8;
            --radius: 30px;
            --shadow: 0 35px 90px rgba(0, 0, 0, 0.62);
        }

        * { box-sizing: border-box; }
        html, body { height: 100%; }

        body {
            margin: 0;
            color: var(--ink);
            font-family: Inter, system-ui, -apple-system, Segoe UI, sans-serif;
            overflow-x: hidden;
            background:
                radial-gradient(1100px 720px at 15% 15%, rgba(255, 77, 141, 0.18), transparent 60%),
                radial-gradient(980px 680px at 85% 18%, rgba(180, 107, 255, 0.16), transparent 58%),
                radial-gradient(900px 700px at 50% 92%, rgba(102, 216, 255, 0.10), transparent 62%),
                linear-gradient(165deg, var(--bg0), var(--bg1));
            -webkit-tap-highlight-color: transparent;
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
            overscroll-behavior-y: none;
        }

        /* Cinematic layers */
        .aurora {
            position: fixed;
            inset: -20vh -25vw;
            z-index: 0;
            pointer-events: none;
            filter: blur(55px) saturate(1.25);
            opacity: 0.95;
            transform: translate3d(var(--px, 0px), var(--py, 0px), 0) rotate(-8deg);
            transition: transform 160ms ease-out;
            background:
                radial-gradient(520px 420px at 18% 30%, rgba(255, 77, 141, 0.28), transparent 70%),
                radial-gradient(520px 420px at 72% 28%, rgba(180, 107, 255, 0.24), transparent 72%),
                radial-gradient(560px 520px at 50% 70%, rgba(102, 216, 255, 0.16), transparent 74%);
            animation: auroraBreath 6.8s ease-in-out infinite;
        }

        @keyframes auroraBreath {
            0%, 100% { opacity: 0.72; }
            50% { opacity: 1; }
        }

        .ribbons {
            position: fixed;
            inset: 0;
            z-index: 1;
            pointer-events: none;
            opacity: 0.55;
            background:
                radial-gradient(900px 240px at 35% 18%, rgba(255, 158, 192, 0.12), transparent 60%),
                radial-gradient(900px 240px at 65% 78%, rgba(255, 209, 168, 0.10), transparent 62%);
            mix-blend-mode: screen;
            animation: ribbonsDrift 9.5s ease-in-out infinite;
        }

        @keyframes ribbonsDrift {
            0% { transform: translate3d(-1.5%, -0.6%, 0) scale(1.02); }
            50% { transform: translate3d(1.8%, 0.8%, 0) scale(1.04); }
            100% { transform: translate3d(-1.5%, -0.6%, 0) scale(1.02); }
        }

        /* Film grain + vignette via SVG data URI (no external assets) */
        .film {
            position: fixed;
            inset: 0;
            z-index: 5;
            pointer-events: none;
        }
        .film::before {
            content: "";
            position: absolute;
            inset: -20%;
            opacity: 0.15;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
            background-size: 220px 220px;
            animation: grain 1.25s steps(2) infinite;
            mix-blend-mode: overlay;
        }
        .film::after {
            content: "";
            position: absolute;
            inset: 0;
            background: radial-gradient(1200px 900px at 50% 45%, transparent 56%, rgba(0,0,0,0.78) 100%);
            opacity: 0.9;
        }
        @keyframes grain {
            0% { transform: translate3d(-2%, -1%, 0); }
            25% { transform: translate3d(1%, -3%, 0); }
            50% { transform: translate3d(3%, 2%, 0); }
            75% { transform: translate3d(-3%, 1%, 0); }
            100% { transform: translate3d(-2%, -1%, 0); }
        }

        canvas#fx {
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        .stage {
            position: relative;
            z-index: 4;
            min-height: 100svh;
            display: grid;
            place-items: center;
            padding:
                max(18px, env(safe-area-inset-top))
                max(16px, env(safe-area-inset-right))
                max(18px, env(safe-area-inset-bottom))
                max(16px, env(safe-area-inset-left));
        }

        .card {
            width: min(760px, 100%);
            border-radius: var(--radius);
            background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
            border: 1px solid rgba(255, 246, 242, 0.18);
            box-shadow: var(--shadow);
            backdrop-filter: blur(16px);
            padding: 18px;
            max-height: calc(100svh - 32px);
            overflow: auto;
            -webkit-overflow-scrolling: touch;
            transform: translateY(18px) scale(0.985);
            opacity: 0;
            transition: opacity 900ms cubic-bezier(.2,.9,.2,1), transform 900ms cubic-bezier(.2,.9,.2,1);
        }

        /* Make scrolling feel intentional (mobile) */
        .card::-webkit-scrollbar { width: 0; height: 0; }

        body.begun .card {
            opacity: 1;
            transform: translateY(0) scale(1);
        }

        .inner {
            position: relative;
            border-radius: calc(var(--radius) - 10px);
            padding: 22px;
            background: rgba(9, 7, 16, 0.55);
            border: 1px solid rgba(255, 246, 242, 0.10);
            overflow: hidden;
        }

        /* Ornamental glow border */
        .inner::before {
            content: "";
            position: absolute;
            inset: -2px;
            border-radius: inherit;
            background: conic-gradient(from 180deg,
                rgba(255, 77, 141, 0.0), rgba(255, 77, 141, 0.25), rgba(180, 107, 255, 0.18), rgba(102, 216, 255, 0.14), rgba(255, 209, 168, 0.18), rgba(255, 77, 141, 0.0)
            );
            filter: blur(10px);
            opacity: 0.55;
            pointer-events: none;
            animation: haloSpin 9.8s linear infinite;
        }
        @keyframes haloSpin {
            to { transform: rotate(360deg); }
        }

        .inner::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: inherit;
            background: radial-gradient(900px 260px at 22% 0%, rgba(255, 255, 255, 0.12), transparent 60%);
            opacity: 0.7;
            pointer-events: none;
        }

        .topline {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            position: relative;
            z-index: 1;
        }

        .pill {
            font-size: 12px;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            color: rgba(255, 246, 242, 0.70);
            border: 1px solid rgba(255, 246, 242, 0.14);
            background: rgba(255, 246, 242, 0.05);
            padding: 8px 10px;
            border-radius: 999px;
            user-select: none;
        }

        h1 {
            margin: 8px 0 8px;
            font-family: "Great Vibes", "Dancing Script", "Cormorant Garamond", serif;
            font-weight: 400;
            line-height: 1.02;
            font-size: clamp(2.35rem, 10vw, 4.1rem);
            letter-spacing: 0.01em;
            position: relative;
            z-index: 1;
        }

        /* Shimmer text */
        .shimmer {
            background: linear-gradient(90deg, rgba(255,246,242,0.75), rgba(255, 158, 192, 0.95), rgba(180, 107, 255, 0.9), rgba(255,246,242,0.78));
            background-size: 220% 100%;
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            animation: shimmer 4.8s ease-in-out infinite;
            text-shadow: 0 0 30px rgba(255, 77, 141, 0.12);
        }
        @keyframes shimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .subtitle {
            margin: 0 0 18px;
            font-family: "Dancing Script", "Cormorant Garamond", serif;
            font-weight: 600;
            color: rgba(255, 246, 242, 0.86);
            font-size: clamp(1.25rem, 5.2vw, 1.75rem);
            line-height: 1.35;
            position: relative;
            z-index: 1;
        }

        .message {
            margin: 0;
            font-family: "Dancing Script", "Cormorant Garamond", serif;
            font-size: clamp(1.18rem, 5vw, 1.55rem);
            line-height: 1.65;
            color: rgba(255, 246, 242, 0.86);
            white-space: pre-wrap;
            letter-spacing: 0.01em;
            position: relative;
            z-index: 1;
        }

        .signature {
            margin-top: 18px;
            font-family: "Dancing Script", "Great Vibes", "Cormorant Garamond", serif;
            font-size: clamp(1.25rem, 5.4vw, 1.75rem);
            color: rgba(255, 246, 242, 0.94);
            text-align: right;
            white-space: pre-wrap;
            position: relative;
            z-index: 1;
        }

        .cursor {
            display: inline-block;
            width: 10px;
            height: 1.15em;
            vertical-align: -0.2em;
            margin-left: 4px;
            border-radius: 2px;
            background: linear-gradient(180deg, rgba(255, 246, 242, 0.95), rgba(255, 246, 242, 0));
            animation: blink 0.9s steps(1) infinite;
        }
        @keyframes blink { 0%,49%{opacity:1} 50%,100%{opacity:0} }

        /* Intro overlay: more magical + cinematic */
        .overlay {
            position: fixed;
            inset: 0;
            z-index: 20;
            display: grid;
            place-items: center;
            padding: 22px;
            background:
                radial-gradient(900px 520px at 50% 30%, rgba(255, 77, 141, 0.22), transparent 60%),
                radial-gradient(900px 520px at 65% 70%, rgba(180, 107, 255, 0.16), transparent 62%),
                rgba(2, 1, 6, 0.78);
            backdrop-filter: blur(12px);
            transition: opacity 700ms ease, transform 700ms ease;
        }

        .overlay.hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateY(12px);
        }

        .overlay-card {
            width: min(560px, 100%);
            border-radius: 26px;
            border: 1px solid rgba(255, 246, 242, 0.18);
            background: rgba(10, 8, 18, 0.70);
            box-shadow: 0 35px 100px rgba(0,0,0,0.60);
            padding: 22px;
            text-align: center;
            overflow: hidden;
            position: relative;
        }

        .overlay-card::before {
            content: "";
            position: absolute;
            inset: -40%;
            background:
                radial-gradient(circle at 30% 30%, rgba(255, 158, 192, 0.22), transparent 55%),
                radial-gradient(circle at 70% 45%, rgba(180, 107, 255, 0.18), transparent 60%),
                radial-gradient(circle at 55% 80%, rgba(102, 216, 255, 0.12), transparent 62%);
            filter: blur(22px);
            opacity: 0.8;
            animation: overlayGlow 6.5s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes overlayGlow {
            0%, 100% { transform: translate3d(-2%, -1%, 0) scale(1.02); }
            50% { transform: translate3d(2%, 1%, 0) scale(1.06); }
        }

        .overlay-title {
            position: relative;
            z-index: 1;
            font-family: "Cormorant Garamond", serif;
            font-size: clamp(1.7rem, 6.2vw, 2.35rem);
            margin: 6px 0 6px;
            letter-spacing: 0.02em;
        }

        .overlay-sub {
            position: relative;
            z-index: 1;
            margin: 0 0 16px;
            color: rgba(255, 246, 242, 0.78);
            line-height: 1.55;
            font-size: 1rem;
        }

        .countdown {
            position: relative;
            z-index: 1;
            font-family: "Cormorant Garamond", serif;
            font-weight: 600;
            font-size: clamp(2.1rem, 8vw, 3rem);
            letter-spacing: 0.08em;
            margin: 4px 0 14px;
            color: rgba(255, 246, 242, 0.92);
            text-shadow: 0 0 22px rgba(255, 77, 141, 0.18);
            min-height: 1.2em;
        }

        .cta {
            position: relative;
            z-index: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: 1px solid rgba(255, 246, 242, 0.24);
            background: linear-gradient(135deg, rgba(255, 77, 141, 0.34), rgba(180, 107, 255, 0.20));
            color: rgba(255, 246, 242, 0.95);
            padding: 12px 18px;
            border-radius: 999px;
            font-size: 14px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
            transition: transform 180ms ease, border-color 180ms ease, filter 180ms ease;
        }
        .cta:hover { border-color: rgba(255, 246, 242, 0.36); filter: brightness(1.05); }
        .cta:active { transform: scale(0.98); }

        .tiny {
            position: relative;
            z-index: 1;
            margin-top: 10px;
            font-size: 12px;
            letter-spacing: 0.22em;
            text-transform: uppercase;
            color: rgba(255, 246, 242, 0.62);
        }

        @media (prefers-reduced-motion: reduce) {
            .aurora, .ribbons { animation: none; transition: none; }
            .film::before { animation: none; }
            .inner::before { animation: none; }
            .shimmer { animation: none; color: var(--ink); background: none; }
        }

        @media (max-width: 520px) {
            .stage {
                place-items: start center;
                padding-top: max(22px, env(safe-area-inset-top));
                padding-bottom: max(22px, env(safe-area-inset-bottom));
            }
            .card { padding: 14px; border-radius: 24px; }
            .inner { padding: 18px; }
            h1 { font-size: clamp(2.2rem, 11.5vw, 3.6rem); }
            .subtitle { font-size: clamp(1.2rem, 6vw, 1.55rem); }
            .message { font-size: clamp(1.12rem, 5.6vw, 1.42rem); }
            .signature { font-size: clamp(1.2rem, 6.2vw, 1.6rem); }

            .overlay-card { padding: 18px; }
            .cta { width: 100%; padding: 14px 18px; }
            .pill { padding: 7px 10px; }
        }

        @media (max-width: 360px) {
            .inner { padding: 16px; }
            .pill { font-size: 11px; padding: 7px 9px; }
        }
    </style>
</head>

<body>
    <div class="aurora" aria-hidden="true"></div>
    <div class="ribbons" aria-hidden="true"></div>
    <canvas id="fx" aria-hidden="true"></canvas>
    <div class="film" aria-hidden="true"></div>

    <!-- Tap overlay (also used as autoplay fallback). Keeps the experience feeling like a surprise. -->
    <div id="overlay" class="overlay" role="dialog" aria-modal="true" aria-label="Click to begin">
        <div class="overlay-card">
            <div id="overlayTitle" class="overlay-title">A midnight surprise</div>
            <p id="overlaySub" class="overlay-sub">Tap anywhere to begin.</p>
            <div id="countdown" class="countdown"></div>
            <button id="beginBtn" class="cta" type="button">Click to begin</button>
            <div class="tiny">2026</div>
        </div>
    </div>

    <main class="stage">
        <section class="card" aria-label="New Year message">
            <div class="inner">
                <div class="topline">
                    <div class="pill">New Year</div>
                    <div class="pill" aria-label="Year">2026</div>
                </div>
                <h1 id="title" class="shimmer"></h1>
                <p id="subtitle" class="subtitle"></p>
                <p id="message" class="message"></p>
                <div id="signature" class="signature"></div>
            </div>
        </section>
    </main>

    <!-- Background music (must be ny.mp3 in same folder). -->
    <audio id="bgm" preload="auto" loop playsinline>
        <source src="ny.mp3" type="audio/mpeg" />
    </audio>

    <script>
        // =====================
        // CONFIG / COPY
        // =====================
        const YEAR = 2026;
        const copy = {
            title: "Happy New Year , My Salsaâ¤ï¸",
            subtitle: "Our first year that we start it together",
            messageLines: [
                "And we gonna end it together ,",
                "I want you to know that I love you no matter the time no matter the place",
                "My heart is always with you,",
                "In 2026",
                "I wish u happiness that stays ,joy that never disappears and love that never feels unsure (AnaðŸ˜›).",
                "my heart will always carry you through everything we'll be through ,",
                "If the world feels loud and heavy , I hope you can find your peace in me .",
                "And If time ever tries to take you away from me,",
                "Iâ€™ll follow you into every year that exists.",
                "",
                "",
                "LOVE YOU,",
                "Always And Forever."
            ],
            signature: "Your Bany"
        };

        const els = {
            overlay: document.getElementById('overlay'),
            beginBtn: document.getElementById('beginBtn'),
            overlayTitle: document.getElementById('overlayTitle'),
            overlaySub: document.getElementById('overlaySub'),
            countdown: document.getElementById('countdown'),
            title: document.getElementById('title'),
            subtitle: document.getElementById('subtitle'),
            message: document.getElementById('message'),
            signature: document.getElementById('signature'),
            bgm: document.getElementById('bgm'),
            canvas: document.getElementById('fx')
        };

        // Ensure year is always 2026
        document.querySelectorAll('[aria-label="Year"], .pill').forEach((n) => {
            if (n.textContent.trim() === '2026') n.textContent = String(YEAR);
        });

        function sleep(ms) { return new Promise((r) => setTimeout(r, ms)); }

        // =====================
        // MUSIC (autoplay best-effort)
        // =====================
        function softVolume() { els.bgm.volume = 0.14; }

        async function tryPlayUnmuted() {
            softVolume();
            els.bgm.muted = false;
            await els.bgm.play();
            return true;
        }

        async function tryPlayMuted() {
            softVolume();
            els.bgm.muted = true;
            await els.bgm.play();
            return true;
        }

        async function fadeInUnmute() {
            // Romantic fade-in from silent to soft volume
            els.bgm.muted = false;
            const target = 0.14;
            els.bgm.volume = 0.0;
            const steps = 24;
            for (let i = 0; i <= steps; i++) {
                els.bgm.volume = target * (i / steps);
                await sleep(28);
            }
        }

        async function initMusic() {
            // Ensure the browser has a fresh decode pipeline
            try { els.bgm.load(); } catch (_) {}

            // Try unmuted first
            try {
                await tryPlayUnmuted();
                return { needsTap: false };
            } catch (_) {
                // Try muted autoplay (often allowed)
                try {
                    await tryPlayMuted();
                    return { needsTap: true };
                } catch (_) {
                    return { needsTap: true };
                }
            }
        }

        async function tryAutoUnmuteWithoutGesture() {
            // Some browsers still allow unmute after a short delay; if not, this fails harmlessly.
            try {
                await sleep(950);
                if (!els.bgm.paused) {
                    await fadeInUnmute();
                } else {
                    // Re-try play unmuted
                    els.bgm.muted = false;
                    await els.bgm.play();
                    await fadeInUnmute();
                }
            } catch (_) {
                // Autoplay with sound is restricted on many mobile browsers.
                // We keep the interaction fallback listener so a single tap can enable audio.
            }
        }

        // =====================
        // TEXT REVEAL (more cinematic pacing)
        // =====================
        async function typeInto(el, text, { min = 14, max = 34, cursor = true } = {}) {
            el.textContent = '';
            let cursorEl = null;
            if (cursor) {
                cursorEl = document.createElement('span');
                cursorEl.className = 'cursor';
                el.appendChild(cursorEl);
            }
            for (let i = 0; i < text.length; i++) {
                if (cursorEl) cursorEl.remove();
                el.textContent += text[i];
                if (cursorEl) el.appendChild(cursorEl);
                const d = min + Math.random() * (max - min);
                await sleep(d);
            }
            if (cursorEl) cursorEl.remove();
        }

        async function revealText() {
            await typeInto(els.title, copy.title, { min: 16, max: 34, cursor: true });
            await sleep(220);
            await typeInto(els.subtitle, copy.subtitle, { min: 12, max: 26, cursor: true });
            await sleep(320);

            els.message.textContent = '';
            for (let i = 0; i < copy.messageLines.length; i++) {
                const line = copy.messageLines[i];
                const span = document.createElement('span');
                els.message.appendChild(span);
                await typeInto(span, line + (i < copy.messageLines.length - 1 ? "\n\n" : ""), { min: 10, max: 22, cursor: true });
                await sleep(220);
            }

            await sleep(240);
            await typeInto(els.signature, copy.signature, { min: 14, max: 30, cursor: true });
        }

        // =====================
        // INTRO (countdown + gentle transition)
        // =====================
        async function runCountdown() {
            const seq = ['3', '2', '1', String(YEAR)];
            els.countdown.textContent = '';
            for (let i = 0; i < seq.length; i++) {
                els.countdown.textContent = seq[i];
                // tiny fireworks burst on each tick
                burst(window.innerWidth * 0.5, window.innerHeight * 0.32, i === seq.length - 1 ? 64 : 28);
                await sleep(i === seq.length - 1 ? 650 : 520);
            }
        }

        function hideOverlay() {
            els.overlay.classList.add('hidden');
            setTimeout(() => {
                els.overlay.style.display = 'none';
            }, 800);
        }

        async function beginExperience() {
            if (document.body.classList.contains('begun')) return;
            document.body.classList.add('begun');
            await sleep(280);
            revealText();
            // extra celebratory fireworks
            burst(window.innerWidth * 0.22, window.innerHeight * 0.40, 56);
            burst(window.innerWidth * 0.78, window.innerHeight * 0.38, 56);
        }

        // =====================
        // CANVAS FX (hearts + sparkles + fireworks)
        // =====================
        const ctx = els.canvas.getContext('2d', { alpha: true });
        const isMobile = window.matchMedia && window.matchMedia('(max-width: 520px)').matches;
        const dpr = Math.max(1, Math.min(isMobile ? 1.5 : 2, window.devicePixelRatio || 1));
        let W = 0, H = 0;

        function resize() {
            W = Math.floor(window.innerWidth);
            H = Math.floor(window.innerHeight);
            els.canvas.width = Math.floor(W * dpr);
            els.canvas.height = Math.floor(H * dpr);
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }
        window.addEventListener('resize', resize, { passive: true });
        resize();

        function rand(min, max) { return min + Math.random() * (max - min); }

        const palette = [
            { r: 255, g: 77, b: 141 },
            { r: 255, g: 158, b: 192 },
            { r: 180, g: 107, b: 255 },
            { r: 102, g: 216, b: 255 },
            { r: 255, g: 209, b: 168 },
            { r: 255, g: 246, b: 242 }
        ];

        const floaters = [];
        const sparks = [];

        function spawnFloater() {
            const c = palette[Math.floor(Math.random() * palette.length)];
            const heart = Math.random() < 0.42;
            floaters.push({
                x: rand(0, W),
                y: H + rand(10, 120),
                vx: rand(-0.06, 0.06),
                vy: rand(-0.30, -0.10),
                r: rand(0, Math.PI * 2),
                vr: rand(-0.004, 0.004),
                size: heart ? rand(0.8, 1.55) : rand(0.6, 1.2),
                a: heart ? rand(0.18, 0.34) : rand(0.12, 0.22),
                c,
                heart,
                phase: rand(0, Math.PI * 2)
            });
        }

        function seedFloaters() {
            floaters.length = 0;
            const base = isMobile ? 60 : 80;
            const scale = isMobile ? 12 : 9;
            const cap = isMobile ? 85 : 120;
            const count = Math.round(Math.min(cap, Math.max(base, W / scale)));
            for (let i = 0; i < count; i++) {
                spawnFloater();
                floaters[floaters.length - 1].y = rand(0, H);
            }
        }
        seedFloaters();

        function drawHeart(x, y, s) {
            ctx.save();
            ctx.translate(x, y);
            ctx.scale(s, s);
            ctx.beginPath();
            for (let t = 0; t < Math.PI * 2; t += 0.14) {
                const xx = 16 * Math.pow(Math.sin(t), 3);
                const yy = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
                ctx.lineTo(xx / 18, -yy / 18);
            }
            ctx.closePath();
            ctx.fill();
            ctx.restore();
        }

        function burst(x, y, n = 32) {
            for (let i = 0; i < n; i++) {
                const c = palette[Math.floor(Math.random() * palette.length)];
                const ang = rand(0, Math.PI * 2);
                const sp = rand(1.4, 3.8);
                sparks.push({
                    x, y,
                    vx: Math.cos(ang) * sp,
                    vy: Math.sin(ang) * sp - rand(0.8, 1.8),
                    g: rand(0.02, 0.05),
                    life: rand(35, 70),
                    max: 0,
                    c,
                    size: rand(0.8, 1.8)
                });
            }
        }

        let last = performance.now();
        function tick(now) {
            const dt = Math.min(34, now - last);
            last = now;
            ctx.clearRect(0, 0, W, H);

            // Floating hearts / sparkles
            for (let p of floaters) {
                p.phase += dt * 0.001;
                p.x += (p.vx + Math.sin(p.phase) * 0.02) * dt;
                p.y += p.vy * dt;
                p.r += p.vr * dt;
                if (p.y < -80 || p.x < -80 || p.x > W + 80) {
                    p.x = rand(0, W);
                    p.y = H + rand(20, 160);
                }

                const tw = (Math.sin(p.phase * 1.6) + 1) * 0.5;
                const a = p.a * (0.55 + tw * 0.55);
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.r);
                ctx.fillStyle = `rgba(${p.c.r},${p.c.g},${p.c.b},${a})`;
                ctx.shadowColor = `rgba(${p.c.r},${p.c.g},${p.c.b},${a})`;
                ctx.shadowBlur = p.heart ? 18 : 12;
                if (p.heart) {
                    drawHeart(0, 0, 0.9 * p.size);
                } else {
                    const r = 1.2 + 2.1 * p.size;
                    ctx.beginPath();
                    ctx.arc(0, 0, r, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.restore();
            }

            // Firework sparks
            for (let i = sparks.length - 1; i >= 0; i--) {
                const s = sparks[i];
                s.life -= dt * 0.06;
                s.vy += s.g * dt;
                s.x += s.vx * dt;
                s.y += s.vy * dt;
                const t = Math.max(0, Math.min(1, s.life / 70));
                const a = 0.65 * t;
                ctx.save();
                ctx.translate(s.x, s.y);
                ctx.fillStyle = `rgba(${s.c.r},${s.c.g},${s.c.b},${a})`;
                ctx.shadowColor = `rgba(${s.c.r},${s.c.g},${s.c.b},${a})`;
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.arc(0, 0, s.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
                if (s.life <= 0 || s.x < -120 || s.x > W + 120 || s.y > H + 140) sparks.splice(i, 1);
            }

            requestAnimationFrame(tick);
        }
        requestAnimationFrame(tick);

        // =====================
        // PARALLAX (moves aurora with pointer)
        // =====================
        let tx = 0, ty = 0, cx = 0, cy = 0;
        function setTarget(x, y) {
            const nx = (x / window.innerWidth) * 2 - 1;
            const ny = (y / window.innerHeight) * 2 - 1;
            tx = nx * 18;
            ty = ny * 14;
        }
        window.addEventListener('mousemove', (e) => setTarget(e.clientX, e.clientY), { passive: true });
        window.addEventListener('touchmove', (e) => {
            const t = e.touches && e.touches[0];
            if (t) setTarget(t.clientX, t.clientY);
        }, { passive: true });
        function parallax() {
            cx += (tx - cx) * 0.08;
            cy += (ty - cy) * 0.08;
            document.documentElement.style.setProperty('--px', cx.toFixed(2) + 'px');
            document.documentElement.style.setProperty('--py', cy.toFixed(2) + 'px');
            requestAnimationFrame(parallax);
        }
        requestAnimationFrame(parallax);

        // =====================
        // OVERLAY INTERACTION
        // =====================
        async function onFirstInteraction() {
            // Ensure music is playing, then unmute with a gentle fade
            try {
                if (els.bgm.paused) {
                    els.bgm.muted = true;
                    await els.bgm.play();
                }
            } catch (_) {}
            await fadeInUnmute();
            hideOverlay();
            await beginExperience();
        }

        function bindOverlay() {
            const handler = () => onFirstInteraction();
            els.beginBtn.addEventListener('click', handler);
            els.overlay.addEventListener('click', (e) => {
                if (e.target === els.overlay) handler();
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') handler();
            }, { once: true });

            // Extra robust fallback: any first pointer interaction can enable sound.
            document.addEventListener('pointerdown', handler, { once: true });
        }
        bindOverlay();

        // =====================
        // BOOT
        // =====================
        (async function init() {
            // Set initial title/subtitle empty until reveal
            els.title.textContent = '';
            els.subtitle.textContent = '';
            els.message.textContent = '';
            els.signature.textContent = '';

            // Ambient bursts (cinematic sparkle)
            burst(window.innerWidth * 0.5, window.innerHeight * 0.22, 48);
            burst(window.innerWidth * 0.5, window.innerHeight * 0.26, 36);

            // Attempt immediate autoplay
            const musicState = await initMusic();

            // Update overlay copy depending on whether sound is already playing.
            if (!musicState.needsTap) {
                if (els.overlayTitle) els.overlayTitle.textContent = 'A midnight surprise';
                if (els.overlaySub) els.overlaySub.textContent = 'Just for you.';
            } else {
                if (els.overlayTitle) els.overlayTitle.textContent = 'A midnight surprise';
                if (els.overlaySub) els.overlaySub.textContent = 'Just for you.';
            }

            // If the audio file is missing or canâ€™t be decoded, show a clear hint.
            els.bgm.addEventListener('error', () => {
                if (els.overlaySub) {
                    els.overlaySub.textContent = 'Audio could not load. Make sure ny.mp3 is in the same folder as index.html.';
                }
            }, { once: true });

            // Always run the countdown + begin automatically (no tap required to see the message)
            await sleep(220);
            await runCountdown();
            await beginExperience();

            // If autoplay started muted, attempt an automatic unmute shortly after.
            // If the browser blocks it, the audio will still unmute on the first interaction.
            if (musicState.needsTap) {
                tryAutoUnmuteWithoutGesture();
            } else {
                // If sound autoplay succeeded, fade away the overlay quickly.
                hideOverlay();
            }
        })();
    </script>
</body>
</html>